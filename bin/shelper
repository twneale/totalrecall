#!/usr/bin/env python3.6
import os
import click
import elasticsearch


@click.command()
@click.option('--cmd', '-c', help='Search term for command history.')
def main(cmd):
    es = elasticsearch.Elasticsearch()
    query = {'query': {'match_all': {}}}
    query = {
        "query": {
            "bool": {
            "should": [],
            "must": [],
            }
        }
    }
    query['query']['bool']['must'].append({'match': {'return_code': 0}})

    predicates = dict(PWD='must')
    for key, val in os.environ.items():
        pred = predicates.get(key, 'should')
        query['query']['bool'][pred].append({'match': {'env.' + key: val}})

    query['sort'] = { "start_timestamp": { "order": "desc" },
                      "_score": {"order": "desc"}}
    if cmd:
        query['query']['bool']['must'].append({'match': {'command': cmd}})

    #import pprint
    #pprint.pprint(query)
    results = es.search(index='totalrecall', body=query)
    #import pdb; pdb.set_trace()

    dedupe = set()
    print('{0:<12} {1}'.format('Score', 'Command'))
    print('{0:<12} {1}'.format('==========', '=' * 30))
    for i, result in enumerate(results['hits']['hits']):
        cmd = result['_source']['command']
        if cmd not in dedupe:
            print('{_score:<12} {_source[command]:>8}'.format(**result))
        dedupe.add(cmd)
    #import pdb; pdb.set_trace()


if __name__ == "__main__":
    main()
