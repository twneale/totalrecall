#!/usr/bin/env python3.6
import os
import click
import elasticsearch


@click.command()
@click.option('--return-0', '-r', help='Only show successful commands.')
@click.option('--pwd', '-p', default=True, help='Show all commands, not just PWD.')
def main(return_0, pwd):
    es = elasticsearch.Elasticsearch()
    query = {'query': {'match_all': {}}}
    query = {
        "query": {
            "bool": {
            "should": [],
            "must": [],
            }
        }
    }
    if return_0:
        query['query']['bool']['must'].append({'match': {'return_code': 0}})

    predicates = dict(PWD='must')
    if pwd:
        query['query']['bool']['must'].append({'match': {'env.PWD': os.environ['PWD']}})

    query['sort'] = { "start_timestamp": { "order": "desc" },
                      "_score": {"order": "desc"}}

    #import pprint
    #pprint.pprint(query)
    results = es.search(index='totalrecall', body=query)
    #import pdb; pdb.set_trace()

    print('{0:<12} {1}'.format('Score', 'Command'))
    print('{0:<12} {1}'.format('==========', '=' * 30))
    for i, result in enumerate(results['hits']['hits']):
        cmd = result['_source']['command']
        print('{_source[start_timestamp]:<12} {_source[command]:>8}'.format(**result))
    #import pdb; pdb.set_trace()


if __name__ == "__main__":
    main()
